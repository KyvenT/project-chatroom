datasource db {
  provider = "postgresql"
  url      = env("DB_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Chatroom {
  id          String         @id @default(uuid())
  title       String
  owner       User        @relation(fields: [ownerId], references: [id])
  ownerId     String
  createdAt   DateTime    @default(now())
  messages    Message[]
  members     ChatroomMember[]
  invites     Invite[]
  guests      Guest[]
}

model Message {
  id              String      @id @default(uuid())
  content         String
  senderUser      User?       @relation(fields: [senderUserId], references: [id])
  senderUserId    String?
  senderGuest     Guest?      @relation(fields: [senderGuestId], references: [id])
  senderGuestId   String?
  chatroom        Chatroom    @relation(fields: [chatroomId], references: [id])
  chatroomId      String
  createdAt       DateTime    @default(now())
  editedAt        DateTime?
}

model User {
  id                String      @id @default(uuid())
  email             String?     @unique
  username          String      @unique 
  passwordHash      String
  status            Status      @default(ONLINE)
  createdAt         DateTime    @default(now())
  sentMessages      Message[]
  joinedChatrooms   ChatroomMember[]
  ownedChatrooms    Chatroom[]
  sentInvites       Invite[]    @relation("SentInvite")
  receivedInvites   Invite[]    @relation("ReceivedInvite")
}

model Guest {
  id            String      @id @default(uuid())
  username      String      @unique 
  status        Status      @default(ONLINE)
  createdAt     DateTime    @default(now())
  sentMessages  Message[]
  chatroom      Chatroom    @relation(fields: [chatroomId], references: [id])
  chatroomId    String   
}

model ChatroomMember {
  member      User        @relation(fields: [memberId], references: [id])
  memberId    String
  chatroom    Chatroom    @relation(fields: [chatroomId], references: [id])
  chatroomId  String
  joinedAt    DateTime    @default(now())

  @@id([chatroomId, memberId])
}

model Invite {
  id            String          @default(uuid())
  sender        User            @relation("SentInvite", fields: [senderId], references: [id])
  senderId      String
  receiver      User            @relation("ReceivedInvite", fields: [receiverId], references: [id])
  receiverId    String
  chatroom      Chatroom        @relation(fields: [chatroomId], references: [id])
  chatroomId    String
  status        InviteStatus    @default(PENDING)
  sentAt        DateTime        @default(now())

  @@unique([senderId, receiverId, chatroomId])
}

enum Status {
  ONLINE
  AWAY
  OFFLINE
}

enum InviteStatus {
  ACCEPTED
  PENDING
}